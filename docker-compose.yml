services:
  # Database Services
  mongo:
    image: mongo:latest
    ports:
      - "${USER_MONGO_PORT:-27017}:27017"
    volumes:
      - mongo-data:/data/db
    command: mongod --auth --wiredTigerCacheSizeGB=0.25
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-secure_password}
      - MONGO_INITDB_DATABASE=${MONGO_DB:-1driver}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.4'
    networks:
      - 1driver-network
    restart: unless-stopped

  1driver-main-api:
    build:
      context: ../1driver-main-api
      dockerfile: dockerfile
    ports:
      - "${API_GATEWAY_PORT:-3000}:3000"
    env_file:
      - ../1driver-main-api/.env
    depends_on:
      - mongo
    networks:
      - 1driver-network
    volumes:
      - ./logs/1driver-main-api:/app/logs
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    restart: unless-stopped

  1driver-user-api:
    build:
      context: ../1driver-user-api
      dockerfile: Dockerfile
    ports:
      - "${USER_API_PORT:-3001}:3001"
    env_file:
      - ../1driver-user-api/.env.docker
    depends_on:
      - mongo
    networks:
      - 1driver-network
    volumes:
      - ./logs/1driver-user-api:/app/logs
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    restart: unless-stopped

  1driver-promotion-api:
    build:
      context: ../1driver-promotion-api
      dockerfile: Dockerfile
    ports:
      - "${PROMOTION_API_PORT:-3002}:3000"
    env_file:
      - ../1driver-promotion-api/.env.docker
    depends_on:
      - mongo
    networks:
      - 1driver-network
    volumes:
      - ./logs/1driver-promotion-api:/app/logs
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    restart: unless-stopped

networks:
  1driver-network:
    driver: bridge
    name: 1driver-network

volumes:
  mongo-data:
  1driver-main-api-logs:
  1driver-promotion-api-logs:
  1driver-user-api-logs: